---
title: "p03_master_figures_stats"
output: html_document
---

```{r set-up, echo=FALSE, message=FALSE}

# Libraries
library(tidyverse)
library(kableExtra)
library(lubridate)

library(tidygraph)
library(ggraph)



# remove objects
rm(list=ls())

# Load data
net_data <- readRDS('table_network_by_year.rds')

vote_info <- readRDS('./scraped_data/table_vote_information.rds') %>% 
  mutate(fecha = as.Date(fecha),
         year = year(fecha))

```


# Cuanto votan de acuerdo las parejas de diputados?
```{r overall_votes_in_agreement}

summary_rel_coalition_gen <- net_data %>% 
  group_by(year) %>% 
  summarise(`Prop. votan igual` = mean(n_same_bothpresent, na.rm = TRUE),
            `Prop. votan distinto` = mean(n_opposite_bothpresent, na.rm = TRUE),
            `Prop. alguna abstencion` = mean(n_abst_bothpresent, na.rm = TRUE)) %>% 
  pivot_longer(   cols = starts_with("Prop"),    names_to = "var", values_to = "value")

summary_rel_coalition_gen %>% 
  ggplot(aes(year,value, fill=var)) +
  geom_bar(stat= "identity") +
  scale_x_continuous(breaks = seq(2002, 2020, by = 2)) +
  ggtitle("Cuanto votan de acuerdo las parejas de diputados?")


```



```{r Promedio votos de acuerdo por coalition-mix}

summary_rel_coalition <- net_data %>% 
  group_by(year,rel_coalition) %>% 
  summarise(`Prop. votan igual` = mean(n_same_bothpresent, na.rm = TRUE),
            `Prop. votan distinto` = mean(n_opposite_bothpresent, na.rm = TRUE),
            `Prop. alguna abstencion` = mean(n_abst_bothpresent, na.rm = TRUE)) %>% 
  pivot_longer(   cols = starts_with("Prop"),    names_to = "var", values_to = "value")


summary_rel_coalition %>% 
  filter(var=="Prop. votan igual") %>% 
  filter(rel_coalition!="Independent present") %>% 
  ggplot(aes(year,value)) +
  geom_line(aes(color = rel_coalition)) +
  geom_point(aes(color = rel_coalition)) +
  theme(legend.position="bottom") +
  scale_x_continuous(breaks = seq(2002, 2020, by = 4)) +
  ggtitle('Promedio de porcentaje de votos de acuerdo para distintos tipos de pareja')


```

```{r promedio porcentaje desacuerdo por coalition-mix}

summary_rel_coalition %>% 
  filter(var=="Prop. votan distinto") %>% 
  filter(rel_coalition!="Independent present") %>% 
  ggplot(aes(year,value)) +
  geom_line(aes(color = rel_coalition)) +
  geom_point(aes(color = rel_coalition)) +
  theme(legend.position="bottom") +
  scale_x_continuous(breaks = seq(2002, 2020, by = 4)) +
  ggtitle('Promedio de porcentaje de votos en desacuerdo para distintos tipos de pareja')



```


```{r numero de votaciones aprobadas/no aprobadas por quorum}

vote_info_custom <- vote_info %>% 
  mutate(vote_apobado = (resultado %in% c('APROBADO','UNANIME')),
         quorum_agg = case_when(quorum %in% c('QUORUM CALIFICADO','QUORUM SIMPLE','LEY ORGANICA CONSTITUCIONAL') ~ quorum,
                                quorum %in% c('REFORMA CONSTITUCIONAL 2/3','REFORMA CONSTITUCIONAL 3/5') ~ 'REFORMA CONSTITUCIONAL 2/3 o 3/5' ,
                                quorum %in% c('1/3','2/3 PRESENTES','3/5') ~ 'OTRO' )  )

summary_votes <- vote_info_custom %>% 
  filter(quorum_agg!="OTRO") %>% 
  group_by(quorum_agg,year) %>% 
  summarise(per_aprobado = mean(vote_apobado, na.rm = TRUE))


# REVISAR APROBACIONES EN 2002

summary_votes %>% 
  ggplot(aes(year,per_aprobado)) +
  geom_line(aes(color=quorum_agg)) +
  geom_point(aes(color=quorum_agg)) +
  theme(legend.position="bottom") +
  scale_x_continuous(breaks = seq(2002, 2020, by = 4)) +
  facet_wrap(~quorum_agg) +
  ggtitle('Proporcion votaciones aprobadas por a침o y quorum') 


```


```{r porcentaje_votos_acuerdo_same_party_pairs}

summary_rel_same_party <- net_data %>% 
  filter(party1==party2) %>% 
  filter(party1!='Independientes') %>% 
  filter(party1!='Federaci칩n Regionalista Verde Social') %>% 
  group_by(year,party1,party2) %>% 
  summarise(`Prop. votan igual` = mean(n_same_bothpresent, na.rm = TRUE),
            `Prop. votan distinto` = mean(n_opposite_bothpresent, na.rm = TRUE),
            `Prop. alguna abstencion` = mean(n_abst_bothpresent, na.rm = TRUE)) %>% 
  pivot_longer(   cols = starts_with("Prop"),    names_to = "var", values_to = "value")

summary_rel_same_party %>% 
  filter(var=="Prop. votan igual") %>% 
  ggplot(aes(year,value)) +
  geom_line() +
  geom_point() +
  facet_wrap(~party1) +
  scale_x_continuous(breaks = seq(2002, 2020, by = 4)) +
  ggtitle("Prop. votos de acuerdo para parejas del mismo partido")
  
```

```{r prop votos desacuerdo mismo partido}

summary_rel_same_party %>% 
  filter(var=="Prop. votan distinto") %>% 
  ggplot(aes(year,value)) +
  geom_line() +
  geom_point() +
  facet_wrap(~party1) +
  scale_x_continuous(breaks = seq(2002, 2020, by = 4)) +
  ggtitle("Prop. votos desacuerdo para parejas del mismo partido")

```


```{r Proporcion votos de acuerdo - grupos inter}

summary_rel_inter <- net_data %>% 
  filter(!is.na(rel_party)) %>% 
  group_by(year,rel_party) %>% 
  summarise(`Prop. votan igual` = mean(n_same_bothpresent, na.rm = TRUE),
            `Prop. votan distinto` = mean(n_opposite_bothpresent, na.rm = TRUE),
            `Prop. alguna abstencion` = mean(n_abst_bothpresent, na.rm = TRUE)) %>% 
  pivot_longer(   cols = starts_with("Prop"),    names_to = "var", values_to = "value")

summary_rel_inter %>% 
  filter(var=="Prop. votan igual") %>% 
  ggplot(aes(year,value)) +
  geom_line() +
  geom_point() +
  facet_wrap(~rel_party) +
  scale_x_continuous(breaks = seq(2002, 2020, by = 4)) +
  ggtitle("Prop. votos de acuerdo para parejas Inter-coalici칩n")


```


```{r Prop. votos en desacuerdo para parejas inter-coalicion}

summary_rel_inter %>% 
  filter(var=="Prop. votan distinto") %>% 
  filter(rel_party!="Same Party") %>% 
  ggplot(aes(year,value)) +
  geom_line() +
  geom_point() +
  facet_wrap(~rel_party) +
  scale_x_continuous(breaks = seq(2002, 2020, by = 4)) +
  ggtitle("Prop. votos desacuerdo para parejas Inter-coalici칩n")



```


```{r graph_data_prep}

# Edges
edges <- net_data %>% 
  select(dip_1,dip_2,year,n_same_bothpresent,n_opposite_bothpresent,rel_coalition_gen) %>% 
  transmute(to = dip_1,
         from = dip_2,
         weight = n_same_bothpresent,
         weigh2 = n_opposite_bothpresent,
         year=year,
         type_vote = rel_coalition_gen)



# Trial - only past median
edges <- edges %>% 
  filter(year==2014)

median <- edges %>% 
  summarise(median = median(weight, na.rm = TRUE))

edges_sel <- edges %>% 
  filter(weight>median$median) %>% 
  mutate(to = str_c('d',to),
         from = str_c('d',from))


# Nodes to use
sel_nodes <- c(edges$to,edges$from)

readRDS('./scraped_data/political_affiliation_wtime.rds') %>% 
  select(party) %>% 
  distinct()


# Nodes
nodes <- readRDS('./scraped_data/political_affiliation_wtime.rds') %>% 
  mutate(year = year(date)) %>% 
  group_by(diputado_id,year) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  filter(diputado_id %in% sel_nodes) %>% 
  select(-date,-aux,-bancada,-region,-comunas) %>% 
  transmute(id = str_c('d',diputado_id),
         party = party,
         year = year) 

network_graph <- tbl_graph(nodes = nodes,
                           edges = edges_sel,
                           directed = FALSE,
                           node_key = "id")

network_graph2 <- network_graph %>% 
  filter(!node_is_isolated()) %>% 
  activate(nodes) %>% 
  mutate(degree  = centrality_degree())

# Set color for nodes
node_colors <- readxl::read_xlsx('./scraped_data/table_party_colors.xlsx')

myColors <- node_colors$color
names(myColors) <- node_colors$party
colScale <- scale_colour_manual(name = "party",values = myColors)

edges_sel %>% 
  select(type_vote) %>% 
  distinct()

# Set color for edges
myColors_edges <- c('Cross coalition', 'Same coalition', 'Independent present')
names(myColors_edges) <- c('#ffc6c4', '#c0c0c0', '#00FFFFFF')
colScale_edges <- scale_colour_manual(name = "type_vote",values = myColors_edges)

library(ggnewscale)


ggraph(network_graph2, layout = "fr",weights=weight  ) + 
    geom_node_point(aes(color = party, size=degree)) +
    geom_edge_link(aes(color=type_vote),alpha=0.08) +
    #geom_edge_density(aes(fill = weight)) +
    colScale +
    scale_edge_colour_manual(values = c('#f21212','#fbf8f8','#0d0c0c') ) +
    scale_size_continuous(range = c(3,6)) +
  theme(panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()) 








```




